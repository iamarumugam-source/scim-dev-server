# SCIM Dev Server with Supabase and Vercel

This guide provides a step-by-step process for setting up and deploying this SCIM server application, which uses Supabase for the database and Vercel for hosting. This is a [Next.js](https://nextjs.org) project.

## Prerequisites

Before you begin, ensure you have the following:

- Git installed on your local machine.
- Node.js and npm installed.
- Access to the source code: [iamarumugam-source/scim-dev-server](https://github.com/iamarumugam-source/scim-dev-server)
- An existing Okta OIDC application for handling login.

---

## Full Setup Guide

Follow these steps for the complete initial setup of the project, database, and deployment.

### Part 1: Initial Setup for Hosting and Database

This section covers creating the necessary Vercel and Supabase accounts. Vercel's Storage integration makes this process seamless.

#### Step 1: Create a Vercel Account

1.  Navigate to the Vercel website: [https://vercel.com](https://vercel.com)
2.  Sign up using your preferred method (e.g., “Continue with GitHub”).

#### Step 2: Create a Supabase Database

1.  From your Vercel dashboard, navigate to the **Storage** tab.
2.  Click **Create Database** and select **Supabase** from the list of providers.
3.  Follow the on-screen instructions. This will create a new Supabase project and automatically link it to your Vercel account.

### Part 2: Database Configuration (Supabase)

With the project created, you now need to set up the database schema by creating the necessary tables.

#### Step 3: Access the Supabase Dashboard

In your Vercel project's **Storage** tab, click the **Open in Supabase** link to manage your database.

#### Step 4: Navigate to the SQL Editor

Once in the Supabase dashboard, find and click on **SQL Editor** in the left-hand navigation pane.

#### Step 5: Execute the Schema Script

Copy the entire SQL script below, paste it into the SQL editor, and click **Run**.

```sql
-- Creating source tables START
CREATE TABLE public.scim_users (
  id UUID PRIMARY KEY,
  username TEXT UNIQUE NOT NULL,
  active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  last_modified_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  resource JSONB NOT NULL
);
CREATE TABLE public.scim_groups (
  id UUID PRIMARY KEY,
  display_name TEXT UNIQUE NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  last_modified_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  resource JSONB NOT NULL
);
CREATE TABLE public.scim_logs (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT now(),
  log_data JSONB NOT NULL
);
CREATE TABLE public.api_keys (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  hashed_key TEXT NOT NULL UNIQUE,
  key_prefix TEXT NOT NULL,
  name TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now(),
  last_used_at TIMESTAMPTZ);
-- Creating source tables END

-- Altering tables for security policy START
ALTER TABLE public.scim_users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.scim_groups ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.scim_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.api_keys ENABLE ROW LEVEL SECURITY;
-- Altering tables for security policy END

-- Creating Security Policies START
CREATE POLICY "Public access" ON public.scim_users FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Public access" ON public.scim_groups FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable read access for all users" ON public.scim_logs FOR SELECT USING (true);
CREATE POLICY "Allow full access for service role" ON public.api_keys FOR ALL USING (true) WITH CHECK (true);
-- Creating Security Policies END
```

#### Step 6: Obtain Supabase API Keys

The necessary Supabase environment variables can be found in your Vercel project under the **Storage** tab. You will need these for your local setup.

### Part 3: Local Development Setup

Now, let's get the application running on your local machine.

#### Step 7: Clone the Application Repository

Open your terminal and run the following commands:

```bash
git clone https://github.com/iamarumugam-source/scim-dev-server
cd scim-dev-server
```

#### Step 8: Install Project Dependencies

Install all the required npm packages:

```bash
npm install
```

#### Step 9: Configure Local Environment Variables

1.  Create a new file in the root of the project named `.env.local`.

2.  Copy the contents below and paste them into your new file.

    ```ini
    NEXT_PUBLIC_SUPABASE_URL=""
    SUPABASE_SERVICE_ROLE_KEY=""
    OKTA_CLIENT_ID=""
    OKTA_CLIENT_SECRET=""
    OKTA_ISSUER=""
    NEXTAUTH_SECRET=""
    NEXT_PUBLIC_BASE_URL="http://localhost:3000"
    ```

3.  Populate the variables using the values from your Vercel storage tab and your Okta OIDC application.

#### Step 10: Run the Application Locally

Start the development server:

```bash
npm run dev
```

Open your browser to `http://localhost:3000`. You can test the setup by clicking **Generate Mock** to see if new users and groups are created in your Supabase database.

### Part 4: Deployment to Vercel

With the application working locally, the final step is to deploy it.

#### Step 11: Create a New Vercel Project and Configure Environment Variables

1.  Go to your Vercel Dashboard and click **Add New…** \> **Project**.

2.  Import the Git repository you cloned in Step 7.

3.  Navigate to the **Storage** tab and ensure your Supabase database is connected to this new project. This should add the Supabase variables automatically.

4.  Navigate to **Settings** \> **Environment Variables** and add the following application-specific variables:

    ```ini
    NEXT_PUBLIC_BASE_URL="your-vercel-app-url"
    OKTA_CLIENT_ID="your-okta-client-id"
    OKTA_CLIENT_SECRET="your-okta-client-secret"
    OKTA_ISSUER="your-okta-issuer-url"
    NEXTAUTH_SECRET="generate-a-random-string-for-this"
    ```

#### Step 12: Deploy and Verify

1.  Trigger a new deployment from the **Deployments** tab in Vercel.
2.  Once complete, visit the URL provided by Vercel and perform the same checks you did locally to ensure everything is working as expected.

---

## Local Development Quick Start

Once the full initial setup is complete, you can run the development server at any time with:

```bash
npm run dev
```

Open [http://localhost:3000](https://www.google.com/search?q=http://localhost:3000) with your browser to see the result. You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

---
